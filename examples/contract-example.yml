# Example Contract: API Authentication
#
# This example matches the schema in CONTRACT-SCHEMA.md
# Copy and modify for your own contracts.
#
# Location: docs/contracts/feature_authentication.yml

contract_meta:
  id: feature_authentication
  version: 1
  created_from_spec: "docs/specs/authentication.md"
  covers_reqs:
    - AUTH-001
    - AUTH-002
  owner: "backend-team"

llm_policy:
  enforce: true
  llm_may_modify_non_negotiables: false
  override_phrase: "override_contract: feature_authentication"

rules:
  non_negotiable:
    # AUTH-001: API routes must have authentication
    - id: AUTH-001
      title: "API routes require authMiddleware"
      scope:
        - "src/routes/**/*.ts"
        - "src/api/**/*.ts"
        - "!src/routes/health.ts"      # Exclude health check
        - "!src/routes/public/**"       # Exclude public routes
      behavior:
        forbidden_patterns:
          - pattern: /router\.(get|post|put|delete)\(['"]\/api\/.*['"]\s*,\s*async/
            message: "API route missing authMiddleware before handler"
        required_patterns:
          - pattern: /import.*authMiddleware/
            message: "Must import authMiddleware"
        example_violation: |
          // WRONG - No authentication
          router.post('/api/users', async (req, res) => {
            await User.create(req.body)
          })
        example_compliant: |
          // CORRECT - Has authMiddleware
          router.post('/api/users', authMiddleware, async (req, res) => {
            await User.create(req.body)
          })

    # AUTH-002: Tokens in httpOnly cookies only
    - id: AUTH-002
      title: "Auth tokens in httpOnly cookies, never localStorage"
      scope:
        - "src/**/*.ts"
        - "src/**/*.js"
      behavior:
        forbidden_patterns:
          - pattern: /localStorage\.setItem\([^)]*token/i
            message: "Tokens must not be stored in localStorage"
          - pattern: /localStorage\.setItem\([^)]*auth/i
            message: "Auth data must not be stored in localStorage"
          - pattern: /sessionStorage\.setItem\([^)]*token/i
            message: "Tokens must not be stored in sessionStorage"
        required_patterns:
          - pattern: /httpOnly\s*:\s*true/
            message: "Token cookies must have httpOnly flag"
        example_violation: |
          // WRONG - localStorage is vulnerable to XSS
          localStorage.setItem('token', jwt)
        example_compliant: |
          // CORRECT - httpOnly cookie
          res.cookie('token', jwt, { httpOnly: true, secure: true })

  soft:
    # AUTH-010: Rate limiting (recommended, not enforced)
    - id: AUTH-010
      title: "Rate limiting on auth endpoints"
      suggestion: "Add rate limiting middleware to /login and /register"
      llm_may_bend_if:
        - "Infrastructure handles rate limiting (CloudFlare, API Gateway)"
        - "User explicitly requests different approach"

compliance_checklist:
  before_editing_files:
    - question: "Adding or modifying an API route?"
      if_yes: "Add authMiddleware as first parameter after the path"
    - question: "Storing auth tokens or credentials?"
      if_yes: "Use httpOnly cookies, never localStorage or sessionStorage"
    - question: "Creating a public endpoint?"
      if_yes: "Add to scope exclusions in contract (!src/routes/public/**)"

test_hooks:
  tests:
    - file: "src/__tests__/contracts/auth.test.ts"
      description: "Scans for AUTH-001 and AUTH-002 violations"
  tooling:
    checker_script: "scripts/check-contracts.js"
