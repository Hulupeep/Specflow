var a=class extends Error{constructor(r,n,s=!1){super(r);this.status=n;this.rateLimited=s;this.name="GitHubError"}},c=class extends Error{constructor(t){super(t),this.name="ConfigurationError"}};function T(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"").substring(0,50)}function P(e){let t=new Date(e);return{year:t.getUTCFullYear().toString(),month:String(t.getUTCMonth()+1).padStart(2,"0"),day:String(t.getUTCDate()).padStart(2,"0")}}function h(e,t,r){let{year:n,month:s,day:o}=P(r),i=T(t)||"note";return`${e.replace(/^\/+|\/+$/g,"")}/${n}/${s}/${o}/${i}.md`}function d(e){return(e.split(`
`)[0]||"").replace(/^#+\s*/,"").replace(/[*_`~]/g,"").trim().substring(0,80)}function C(e){let r=(e.match(/#([a-zA-Z][a-zA-Z0-9_-]{1,})/g)||[]).map(n=>n.slice(1).toLowerCase()).filter(n=>!(/^[a-f0-9]{3}$/.test(n)||/^[a-f0-9]{6}$/.test(n)));return[...new Set(r)]}function v(e,t){let{metadata:r,topic:n,tags:s}=e,o=["---"];if(o.push(`source: ${r.source}`),o.push(`captured_at: ${r.capturedAt}`),r.sourceUrl&&o.push(`url: "${r.sourceUrl}"`),r.sourceTitle&&o.push(`page_title: "${R(r.sourceTitle)}"`),r.pageContext&&o.push(`page_context: "${R(r.pageContext)}"`),o.push(`repo_label: "${t.label}"`),o.push(`topic: "${R(n)}"`),o.push("tags:"),s.length===0)o.push("  []");else for(let i of s)o.push(`  - ${i}`);return o.push("---"),o.join(`
`)}function R(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n")}function w(e,t){let n=`${v(e,t)}

${e.content}`,s=h(t.basePath,e.topic,e.metadata.capturedAt),o=`Add note: ${e.topic}`;return{path:s,commitMessage:o,body:n}}var $="https://api.github.com",H=3,l=class{constructor(t,r){this.token=t;this.fetchFn=r||fetch.bind(globalThis)}async createFile(t,r){let n=`${$}/repos/${t.owner}/${t.repo}/contents/${r.path}`,s=JSON.stringify({message:r.commitMessage,content:this.base64Encode(r.body),branch:t.defaultBranch}),o=await this.makeRequest(n,"PUT",s);if(o.ok){let i=await o.json();return{htmlUrl:i.content.html_url,path:i.content.path}}throw await this.handleError(o),new a("Unknown error",o.status)}async createFileWithRetry(t,r,n=H){let s=null;for(let o=0;o<n;o++)try{let i=o===0?r:this.addSuffixToPath(r,o);return await this.createFile(t,i)}catch(i){if(i instanceof a&&(i.status===409||i.status===422)){s=i;continue}throw i}throw s||new a("Max retries exceeded",409)}addSuffixToPath(t,r){let n=t.path.replace(".md",`-${r}.md`);return{...t,path:n}}async makeRequest(t,r,n){let s={Authorization:`Bearer ${this.token}`,Accept:"application/vnd.github.v3+json","Content-Type":"application/json"};return this.fetchFn(t,{method:r,headers:s,body:n})}async handleError(t){let r=t.status;throw r===403?t.headers.get("X-RateLimit-Remaining")==="0"?new a("Rate limit reached. Try again later.",403,!0):new a("Access denied. Check your token permissions.",403):r===404?new a("Repository not found. Check owner and repo name.",404):r===409||r===422?new a("File already exists.",409):r>=500?new a("GitHub is having issues. Please try again.",r):new a(`Request failed with status ${r}`,r)}base64Encode(t){return typeof Buffer<"u"?Buffer.from(t,"utf-8").toString("base64"):btoa(unescape(encodeURIComponent(t)))}};var g=class{constructor(t){this.deps=t}async performCapture(t){let r=await this.deps.getToken();if(!r)throw new c("GitHub token not configured.");let n=await this.deps.findRepoConfig(t.repoId);if(!n)throw new c("Repository configuration not found.");this.validateRequest(t);let s=w(t,n);return new l(r).createFileWithRetry(n,s)}validateRequest(t){if(!t.content||t.content.trim().length===0)throw new c("Content cannot be empty.");if(!t.topic||t.topic.trim().length===0)throw new c("Topic cannot be empty.");if(!Array.isArray(t.tags))throw new c("Tags must be an array.")}};var u={PAT:"github_pat",REPOS:"repo_configs",DEFAULT_REPO:"default_repo_id",DEFAULT_TAGS:"default_tags",QUICK_SEND_DEFAULTS:"quick_send_defaults"};async function x(){return(await chrome.storage.local.get(u.PAT))[u.PAT]||null}async function p(){return(await chrome.storage.local.get(u.REPOS))[u.REPOS]||[]}async function S(e){return(await p()).find(r=>r.id===e)}async function f(){return(await chrome.storage.local.get(u.DEFAULT_REPO))[u.DEFAULT_REPO]||null}async function D(){return(await chrome.storage.local.get(u.DEFAULT_TAGS))[u.DEFAULT_TAGS]||[]}async function y(){return(await chrome.storage.local.get(u.QUICK_SEND_DEFAULTS))[u.QUICK_SEND_DEFAULTS]||null}async function F(e){await chrome.storage.local.set({[u.QUICK_SEND_DEFAULTS]:e})}async function E(){let[e,t]=await Promise.all([x(),p()]);return{hasToken:!!e,hasRepos:t.length>0}}async function m(e){switch(e.type){case"get-config-status":return I();case"get-repo-configs":return L();case"perform-capture":return k(e.payload);case"quick-capture":return M(e.payload);case"get-quick-send-defaults":return Q();case"save-quick-send-defaults":return O(e.payload);default:return{error:"Unknown message type"}}}async function I(){let{hasToken:e,hasRepos:t}=await E(),r=await p(),n=await f(),s=r.find(o=>o.id===n)||r[0];return{configured:e&&t,hasToken:e,hasRepos:t,defaultRepo:s?{owner:s.owner,repo:s.repo}:void 0}}async function L(){var r;let e=await p(),t=await f();return{repos:e.map(n=>({id:n.id,label:n.label,owner:n.owner,repo:n.repo})),defaultRepoId:t||((r=e[0])==null?void 0:r.id)}}async function k(e){try{return{success:!0,result:await new g({findRepoConfig:S,getToken:x}).performCapture({repoId:e.repoId,content:e.content,topic:e.topic,tags:e.tags,metadata:{source:e.source,capturedAt:new Date().toISOString(),sourceUrl:e.sourceUrl,sourceTitle:e.sourceTitle,pageContext:e.pageContext}})}}catch(t){return N(t)}}async function M(e){let t=await y(),r=(t==null?void 0:t.repoId)||await f(),n=await p();if(!r||n.length===0)return{success:!1,error:"GitHub is not configured. Open extension options.",errorType:"not_configured"};let s=await D(),o=(t==null?void 0:t.tags)||[],i=C(e.content),b=[e.source,...new Set([...i,...o,...s])],G=d(e.content);return k({repoId:r,content:e.content,topic:G,tags:b,source:e.source,sourceUrl:e.sourceUrl,sourceTitle:e.sourceTitle,pageContext:e.pageContext})}async function Q(){return y()}async function O(e){return await F(e),{success:!0}}function N(e){return e instanceof c?{success:!1,error:e.message,errorType:"not_configured"}:e instanceof a?e.rateLimited?{success:!1,error:"Rate limit reached. Try again later.",errorType:"rate_limit"}:{success:!1,error:e.message,errorType:"network"}:{success:!1,error:"Something went wrong. Please try again.",errorType:"network"}}var U="chat2repo-quick-send";function _(){chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:U,title:"Save to GitHub",contexts:["selection"]})})}async function A(e,t){if(e.selectionText&&e.menuItemId===U)try{let n=await m({type:"quick-capture",payload:{content:e.selectionText,source:"web",sourceUrl:(t==null?void 0:t.url)||"",sourceTitle:(t==null?void 0:t.title)||""}});n.success?chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon48.png"),title:"chat2repo",message:"Saved to GitHub!"}):chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon48.png"),title:"chat2repo",message:n.error||"Failed to save"})}catch(r){console.error("Context menu save failed:",r),chrome.notifications&&chrome.notifications.create({type:"basic",iconUrl:chrome.runtime.getURL("icons/icon48.png"),title:"chat2repo",message:"Failed to save. Check your settings."})}}chrome.runtime.onInstalled.addListener(()=>{_()});chrome.contextMenus.onClicked.addListener(A);chrome.runtime.onMessage.addListener((e,t,r)=>(m(e).then(r).catch(n=>{r({success:!1,error:"Internal error occurred",errorType:"network"})}),!0));
