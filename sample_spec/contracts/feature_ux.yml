contract_meta:
  id: feature_ux
  version: 1
  created_from_spec: "sample_spec/spec.md"
  covers_reqs:
    - UX-001
    - UX-002
    - UX-003
    - ERR-001
    - ERR-002
  owner: "chat2repo-team"
  created_at: "2025-12-03"

llm_policy:
  enforce: true
  llm_may_modify_non_negotiables: false
  override_phrase: "override_contract: feature_ux"

rules:
  non_negotiable:
    - id: UX-001
      title: "Unconfigured state shows toast with settings link, not modal"
      scope:
        - "packages/extension/src/background/**/*.ts"
        - "packages/extension/src/content/**/*.ts"
      behavior:
        required_patterns:
          - pattern: /(?:not configured|missing|setup)/i
            message: "Must check for configuration before capture (UX-001)"
        validation:
          - "Configuration check must happen before any GitHub API call"
          - "Error response must include settings link/action"
          - "No modal shown when unconfigured"
        example_violation: |
          // Shows modal even when unconfigured
          async function handleCapture() {
            showModal()  // Wrong! Should check config first
          }
        example_compliant: |
          async function handleCapture() {
            const config = await getConfig()
            if (!config.pat || !config.repos.length) {
              return { error: 'not_configured', showSettings: true }
            }
            // proceed with capture
          }

    - id: UX-002
      title: "Quick send must not show modal, only toast"
      scope:
        - "packages/extension/src/content/**/*.ts"
        - "packages/extension/src/content/**/*.tsx"
        - "packages/extension/src/background/**/*.ts"
      behavior:
        validation:
          - "Quick send code path must not trigger modal"
          - "Quick send must use saved defaults"
          - "Only toast feedback allowed"
        example_violation: |
          async function quickSend() {
            showModal({ mode: 'quick' })  // Wrong!
          }
        example_compliant: |
          async function quickSend() {
            const result = await chrome.runtime.sendMessage({
              type: 'perform-capture',
              useDefaults: true
            })
            showToast(result.success ? 'Saved!' : result.error)
          }

    - id: UX-003
      title: "ChatGPT buttons only on assistant messages"
      scope:
        - "packages/extension/src/content/chatgptDom.ts"
        - "packages/extension/src/content/chatgptContentScript.ts"
      behavior:
        required_patterns:
          - pattern: /assistant|data-message-author-role/i
            message: "Must filter for assistant messages when injecting buttons (UX-003)"
        forbidden_patterns:
          - pattern: /querySelectorAll\(['"][^'"]*message[^'"]*['"]\)(?!.*assistant)/
            message: "Message selector without assistant filter may target user messages (UX-003)"
        validation:
          - "findAssistantMessages must filter by role"
          - "User messages must not have inject button"
        example_violation: |
          // Targets all messages
          document.querySelectorAll('[data-message-id]').forEach(injectButton)
        example_compliant: |
          // Only assistant messages
          document.querySelectorAll('[data-message-author-role="assistant"]').forEach(injectButton)

    - id: ERR-001
      title: "GitHub errors show friendly message without exposing PAT"
      scope:
        - "packages/extension/src/background/**/*.ts"
        - "packages/core/src/githubClient.ts"
      behavior:
        forbidden_patterns:
          - pattern: /(?:token|pat|authorization)['"]\s*:/i
            message: "Error response must not include token/PAT (ERR-001)"
        required_patterns:
          - pattern: /rate.?limit|try.?again/i
            message: "Rate limit errors must be user-friendly (ERR-001)"
        validation:
          - "403 rate limit: friendly message with retry suggestion"
          - "5xx errors: generic network error message"
          - "No raw error objects exposed to UI"
        example_violation: |
          catch (error) {
            return { error: error.message, headers: error.headers }
          }
        example_compliant: |
          catch (error) {
            if (error.status === 403 && error.rateLimited) {
              return { error: 'rate_limit', message: 'Rate limit reached. Try again later.' }
            }
            return { error: 'network', message: 'Network error. Please try again.' }
          }

    - id: ERR-002
      title: "Empty content triggers fallback toast, not API call"
      scope:
        - "packages/extension/src/content/chatgptContentScript.ts"
        - "packages/extension/src/background/messageHandlers.ts"
      behavior:
        required_patterns:
          - pattern: /(?:null|empty|!content|content\s*===?\s*['"])/
            message: "Must check for empty/null content before capture (ERR-002)"
        validation:
          - "getMessageContent returning null/empty must show fallback toast"
          - "No API calls with empty content"
          - "Toast suggests using text selection instead"
        example_violation: |
          const content = getMessageContent(el)
          // No check - sends empty content!
          sendToBackground({ content })
        example_compliant: |
          const content = getMessageContent(el)
          if (!content) {
            showToast("Couldn't detect message. Select text and use Quick send.")
            return
          }
          sendToBackground({ content })

compliance_checklist:
  before_editing_files:
    - question: "Are you implementing a capture flow?"
      if_yes: "Check configuration first. No API calls if unconfigured."
    - question: "Are you implementing quick send?"
      if_yes: "Must not show modal. Toast only."
    - question: "Are you modifying ChatGPT DOM selectors?"
      if_yes: "Ensure only assistant messages are targeted."
    - question: "Are you handling GitHub errors?"
      if_yes: "Sanitize messages. No PAT exposure. User-friendly text."

test_hooks:
  tests:
    - file: "sample_spec/__tests__/ux.test.js"
      description: "Validates UX flows and error handling"
